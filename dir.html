<html>
<head>
	<title>FS</title>
<script type="text/javascript">
	//This is the directory display stuff here
	var titletext = "Awesome Fileserver"
	var dirname = ""

	function setNameDiv(data, dirnamearea) {
		dirnamearea.innerHTML = data.dirname
	}

	function genFilesDiv(data, filesarea) {
		for(var i=0, len=data.contents.length; i<len; i++) {
			var item = data.contents[i]
			var newdiv = document.createElement("div")
			if( item.type == "file" ) {
				var humansize = humanizeSize(item.size)
				newdiv.innerHTML = "<a href=\"" + item.fileurl + "\">" + item.filename + "</a> Size: " + humansize
			} else if( item.type == "dir" ) {
				newdiv.innerHTML = "<a href=\"" + item.fileurl + "\">" + item.filename + "/</a>"
			}
			filesarea.appendChild(newdiv)
		}
	}
	
	function genFilesTable(data, filetable) {
		for(var i=0, len=data.contents.length; i<len; i++) {
			var item = data.contents[i]
			var row = filetable.insertRow(filetable.rows.length)
			var cellCount = 0
			var filenameCell = row.insertCell(cellCount++)
			var sizeCell = row.insertCell(cellCount++)
			var accessedCell = row.insertCell(cellCount++)
			var modifiedCell = row.insertCell(cellCount++)
			filenameCell.innerHTML = "<a href=\"" + item.fileurl + "\">" + item.filename + "</a>"
			accessedCell.innerHTML = item.dateaccessed
			modifiedCell.innerHTML = item.datemodified
			if( item.type == "file" ) {
				sizeCell.innerHTML = humanizeSize(item.size)
			}
		}
	}

	function setTitle(data) {
		document.title = titletext + " - " + data.dirname
	}

	function humanizeSize(size) {
		var human = ""
		var kb = 1024
		var mb = kb*1024
		var gb = mb*1024
		if(size<1000) {
			human = size + "B"
		} else if(size<mb) {
			human = (size/kb) + "KB"
		} else if(size<gb) {
			human = (size/mb) + "MB"
		} else {
			human = (size/gb) + "GB"
		}
		return human
	}

	function processData(data) {
		dirname = data.dirname
		setTitle(data)

		var dirnamearea = document.getElementById("dirnamediv")
		setNameDiv(data,dirnamearea)

//		var filesarea = document.getElementById("filediv")
//		genFilesDiv(data, filesarea)

		var filestable = document.getElementById("filetable")
		genFilesTable(data, filestable)
	}

	//Put the upload script below here
/*	function messaged(statusbox, msg, ws) {
		if( ws.was_fnsent() ) {
			//TODO: make sure the response is a positive one
			statusbox.innerHTML = "Filename sent"
			ws.sendFile()
		} else if( ws.was_filesent() ) {
			statusbox.innerHTML = "File sent "
		} else {
			statusbox.innerHTML = "Other message " + msg.data
		}
	}*/
	function errored(statusbox) {
		statusbox.innerHTML = "Error received"
	}
	function closed(statusbox) {
		//statusbox.innerHTML = "Closed"
	}
	function refreshDirData() {
		//window.location.reload()
	}
	function send(statusbox, fileselector) {
		if(fileselector.files.length != 1) {
//			alert("Select one and only one file")
			return
		}
		file = fileselector.files[0]

		statusbox.innerHTML = "Connecting"

		var ws	//define ws now so I can use it in the different callbacks
		ws = new UploaderWS( file, dirname,
				function() {	//on open
					statusbox.innerHTML = "Connected"
					ws.sendFilename()
				},
				function(msg) { //on message
					if( ws.was_fnsent() ) {
						if( msg.data == "Write Permitted" ) {
							statusbox.innerHTML = "Filename sent"
							ws.sendFile()
						} else {
							statusbox.innerHTML = "Error sending filename"
							ws.close()	//close
						}
					} else if( ws.was_filesent() ) {
						if( true ) { //TODO: check for positive response
							statusbox.innerHTML = "File sent "
							refreshDirData()
						} else {
							statusbox.innerHTML = "Error sending file"
						}
						ws.close()	//close
					} else {
						statusbox.innerHTML = "Other message " + msg.data
					}
				},
				function() { //on close
					closed(statusbox)
				},
				function() { //on error
					errored(statusbox)
				}
				)	//end new UploaderWS call
	}

	//This defines a custom websocket object
	//Goes through several states - 
	function UploaderWS(fi, dir, onopen, onmessage, onclose, onerror) {
		var NOTHINGSENT = 0
		var FILENAMESENT = 1
		var FILESENDING = 2
		var FILESENT = 3
		var ALLDONE = 4

		var interval = 0
		var state = NOTHINGSENT
		var file = fi

		var fr = new FileReader()
		var readpos = 0
		
		if( dir[0] != "/" ) {
			dir = "/" + dir
		}
		if( dir[dir.length-1] != "/" ) {
			dir = dir + "/"
		}
		var wsURL = "ws://" + document.location.host + dir + file.name

		var socket = new WebSocket(wsURL)
		socket.onopen = onopen
		socket.onmessage = onmessage
		socket.onerror = onerror

		socket.onclose = function() {
			clearInterval(interval)	//Stop the close timer
			interval = 0
			onclose()	//Run the requested onclose event
		}

		//this.socket = socket
		//this.state = state

		this.send = function(data){
			if(typeof socket !== "undefined" && socket.readyState == WebSocket.OPEN) {
				socket.send(data)
			}
		}

		this.was_fnsent = function() {
			return (state == FILENAMESENT)
		}

		this.was_filesent = function() {
			return (state == FILESENT)
		}

		this.sendFilename = function() {
			if(typeof socket !== "undefined" && socket.readyState == WebSocket.OPEN && state == NOTHINGSENT) {
				socket.send("Filesize: " + file.size)
				state = FILENAMESENT
			} else {
				if(state != NOTHINGSENT) {
					alert("Something was already sent fool!") //TODO:remove
				}
			}
		}

		this.sendFile = function() {
			if(typeof socket !== "undefined" && socket.readyState == WebSocket.OPEN && state == FILENAMESENT) {
				state = FILESENDING
				readpos = 0
				;(function sliceandserve() {
					sliced = file.webkitSlice(readpos, readpos+1024)
					fr.onload = function(e) {
						var contents = e.target.result
						//TODO: do something with the contents
						socket.send(contents)
						readpos += 1024
						if( readpos < file.size ) {
							sliceandserve()
						}	else {
							state = FILESENT
						}
					}
					fr.readAsArrayBuffer(sliced)
				})()
			} else {
				alert("other") //TODO:remove
			}
		}

		this.close = function() {
			interval = setInterval( function() {	//Build a function which tries to close the socket every 100ms
					if(typeof socket !== "undefined" && socket.readyState != WebSocket.CLOSED) {
						socket.close()
					}
				}, 100 ) //end setInterval
		}
	}
</script>
</head>
<body>
<input type="button" onclick="send(document.getElementById('status'),document.getElementById('fileselector'))" value="Send">
<input type="file" id="fileselector">
<br><span id="status">Waiting</span>
<div id="dirnamediv">
</div>
<div id="filediv">
<table id="filetable">
<tr><td>Filename</td><td>Size</td><td>Modified Date</td><td>Created Date</td></tr>
</table>
</div>

