<html>
<head>
	<title>FS</title>
<script type="text/javascript">
	//This is the directory display stuff here
	var titletext = "Awesome Fileserver"

	function setNameDiv(data, dirnamearea) {
		dirnamearea.innerHTML = data.dirname
	}

	function genFilesDiv(data, filesarea) {
		for(var i=0, len=data.contents.length; i<len; i++) {
			var item = data.contents[i]
			var newdiv = document.createElement("div")
			if( item.type == "file" ) {
				var humansize = humanizeSize(item.size)
				newdiv.innerHTML = "<a href=\"" + item.fileurl + "\">" + item.filename + "</a> Size: " + humansize
			} else if( item.type == "dir" ) {
				newdiv.innerHTML = "<a href=\"" + item.fileurl + "\">" + item.filename + "/</a>"
			}
			filesarea.appendChild(newdiv)
		}
	}
	
	function genFilesTable(data, filetable) {
		for(var i=0, len=data.contents.length; i<len; i++) {
			var item = data.contents[i]
			var row = filetable.insertRow(filetable.rows.length)
			var cellCount = 0
			var filenameCell = row.insertCell(cellCount++)
			var sizeCell = row.insertCell(cellCount++)
			var accessedCell = row.insertCell(cellCount++)
			var modifiedCell = row.insertCell(cellCount++)
			filenameCell.innerHTML = "<a href=\"" + item.fileurl + "\">" + item.filename + "</a>"
			accessedCell.innerHTML = item.dateaccessed
			modifiedCell.innerHTML = item.datemodified
			if( item.type == "file" ) {
				sizeCell.innerHTML = humanizeSize(item.size)
			}
		}
	}

	function setTitle(data) {
		document.title = titletext + " - " + data.dirname
	}

	function humanizeSize(size) {
		var human = ""
		var kb = 1024
		var mb = kb*1024
		var gb = mb*1024
		if(size<1000) {
			human = size + "B"
		} else if(size<mb) {
			human = (size/kb) + "KB"
		} else if(size<gb) {
			human = (size/mb) + "MB"
		} else {
			human = (size/gb) + "GB"
		}
		return human
	}

	function processData(data) {
		setTitle(data)

		var dirnamearea = document.getElementById("dirnamediv")
		setNameDiv(data,dirnamearea)

//		var filesarea = document.getElementById("filediv")
//		genFilesDiv(data, filesarea)

		var filestable = document.getElementById("filetable")
		genFilesTable(data, filestable)
	}

	//Put the upload script below here
	function opened(statusbox) {
		statusbox.innerHTML = "Connected"
	}
	function messaged(msg,statusbox) {
		statusbox.innerHTML = "Message received " + msg.data
	}
	function errored(statusbox) {
		statusbox.innerHTML = "Error received"
	}
	function closed(statusbox) {
		statusbox.innerHTML = "Closed"
	}
	function send(statusbox, fileselector) {
		if(fileselector.files.length != 1) {
			alert("Select one and only one file")
		}
		statusbox.innerHTML = "Connecting"
		var ws
		ws = new WS(
				function() {	//on open
					opened(statusbox)
					ws.send("Ha ha!")
					ws.close()
				},
				function(msg) { //on message
					messaged(msg,statusbox)
				},
				function() { //on close
					closed(statusbox)
				},
				function() { //on error
					errored(statusbox)
				}
				)	//end new WS call
		/*socket = wsconnect(
				function() {	//on open
					opened(statusbox)
					wssend(socket, "Ha ha!")
					wsclose(socket)
				},
				function(msg) { //on message
					messaged(msg,statusbox)
				},
				function(cls) { //on close
					closed(statusbox)
				},
				function() { //on error
					errored(statusbox)
				}
				)	//end wsconnect call*/
	}
	function WS(onopen, onmessage, onclose, onerror) {
		var interval = 0

		var socket = new WebSocket("ws://localhost:8080/first/second")
		socket.onopen = onopen
		socket.onmessage = onmessage
		socket.onerror = onerror

		socket.onclose = function() {
			clearInterval(interval)	//Stop the close timer
			onclose()	//Run the requested onclose event
		}

		this.socket = socket

		this.send = function(data){
			if(typeof socket !== "undefined" && socket.readyState == WebSocket.OPEN) {
				socket.send(data)
			}
		}

		this.close = function() {
			interval = setInterval( function() {	//Build a function which tries to close the socket every 100ms
					if(typeof socket !== "undefined" && socket.readyState != WebSocket.CLOSED) {
						socket.close()
					}
				}, 100 ) //end setInterval
		}
	}
	function wsconnect(onopen, onmessage, onclose, onerror) {
		socket = new WebSocket("ws://localhost:8080/first/second")
		socket.onopen = onopen
		socket.onmessage = onmessage
		socket.onclose = onclose
		socket.onerror = onerror
		return socket
	}
	function wssend(data) {
		if(typeof socket !== "undefined" && socket.readyState == WebSocket.OPEN) {
			socket.send(data)
		}
	}
	function wsclose(socket) {
		interval = setInterval(wstryclose(socket), 100)	//Try to close the socket every 100 ms
	}
	function wsclose(socket) {
		if(typeof socket !== "undefined" && socket.readyState != WebSocket.CLOSED) {
			socket.close()
		} 
	}
</script>
</head>
<body>
<input type="button" onclick="send(document.getElementById('status'),document.getElementById('fileselector'))" value="Send">
<input type="file" id="fileselector">
<br><span id="status">Waiting</span>
<div id="dirnamediv">
</div>
<div id="filediv">
<table id="filetable">
<tr><td>Filename</td><td>Size</td><td>Modified Date</td><td>Created Date</td></tr>
</table>
</div>

